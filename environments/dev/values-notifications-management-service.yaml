image:
  repository: distrischooldevacr.azurecr.io/notifications-management-service
  tag: "latest"
  pullPolicy: Always

imagePullSecrets:
  - name: acr-secret

replicaCount: 1

resources:
  limits:
    cpu: 300m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 256Mi

env:
  - name: ENVIRONMENT
    value: "dev"
  - name: LOG_LEVEL
    value: "DEBUG"
  - name: SERVER_PORT
    value: "8080"
  - name: SPRING_DATASOURCE_DRIVER_CLASS_NAME
    value: "org.postgresql.Driver"
  - name: SPRING_FLYWAY_ENABLED
    value: "true"
  - name: SPRING_FLYWAY_LOCATIONS
    value: "classpath:db/migration"
  - name: SPRING_FLYWAY_REPAIR_ON_MIGRATE
    value: "true"
  - name: SPRING_FLYWAY_OUT_OF_ORDER
    value: "true"
  - name: KAFKA_BOOTSTRAP_SERVERS
    value: "kafka.infrastructure-dev:29092"
  # Producer configuration - ensure no compression (or use gzip if needed)
  - name: SPRING_KAFKA_PRODUCER_COMPRESSION_TYPE
    value: "none"
  # Consumer configuration - must be able to decompress any format
  - name: SPRING_KAFKA_CONSUMER_PROPERTIES_AUTO_OFFSET_RESET
    value: "earliest"
  - name: SPRING_KAFKA_CONSUMER_PROPERTIES_ENABLE_AUTO_COMMIT
    value: "true"
  - name: SPRING_KAFKA_CONSUMER_PROPERTIES_FETCH_MIN_BYTES
    value: "1"
  # Enable Snappy decompression support for consumers
  # Kafka uses its own Snappy implementation (not xerial.snappy)
  # The Kafka client library should handle Snappy automatically, but we ensure Java mode
  # This is needed if there are existing Snappy-compressed messages in topics
  # Note: Kafka's Snappy codec will automatically fall back to pure Java if native libs unavailable
  - name: JAVA_TOOL_OPTIONS
    value: "-Dorg.xerial.snappy.purejava=true"
  # Configure error handling to prevent consumer crashes
  - name: SPRING_KAFKA_CONSUMER_PROPERTIES_VALUE_DESERIALIZER
    value: "org.springframework.kafka.support.serializer.ErrorHandlingDeserializer"
  - name: SPRING_KAFKA_CONSUMER_PROPERTIES_SPRING_DESERIALIZER_VALUE_DESERIALIZER
    value: "org.springframework.kafka.support.serializer.JsonDeserializer"
  - name: SPRING_KAFKA_CONSUMER_PROPERTIES_SPRING_JSON_TRUSTED_PACKAGES
    value: "*"
  - name: SPRING_KAFKA_LISTENER_ERROR_HANDLER
    value: "org.springframework.kafka.listener.DefaultErrorHandler"
  - name: SPRING_KAFKA_CONSUMER_PROPERTIES_FETCH_MAX_BYTES
    value: "10485760"
  # Skip messages that can't be deserialized
  - name: SPRING_KAFKA_CONSUMER_PROPERTIES_SPRING_DESERIALIZER_VALUE_DESERIALIZER_EXCEPTION_HANDLER
    value: "org.springframework.kafka.listener.DefaultErrorHandler"

secrets:
  enabled: false
  secretName: "notifications-management-service-dev-secrets"

ingress:
  enabled: false
  className: ""
  hosts: []

probe:
  startup:
    enabled: true
    useTcpSocket: true
    initialDelaySeconds: 60
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 48  # Total: 60 + (48 * 30) = 1500 seconds = 25 minutes
  liveness:
    enabled: false
  readiness:
    enabled: false

